pipeline {
    agent {
        label 'docker' 
    }
    environment {
        ANDROID_HOME = '/usr/lib/android-sdk'
        PATH=\$ANDROID_HOME/cmdline-tools/latest/bin:\$PATH
    }
    stages {
        stage('collect-artifacts') {
            agent {
                docker {
                    label 'docker'
                    image 'busybox:latest'
                    args '-v ' + env.WORKSPACE + ':/root --entrypoint=""'
                }
            }
            steps {
                sh 'if [ ! -f android-ndk-r23c-linux.zip ] ; then wget https://dl.google.com/android/repository/android-ndk-r23c-linux.zip ; fi'
                sh 'if [ ! -f platform-27_r03.zip ] ; then wget https://dl.google.com/android/repository/platform-27_r03.zip ; fi'
            }
        }
        stage('build') {
            agent {
                docker {
                    label 'docker'
                    image 'kivy/buildozer:latest'
                    args '-v ' + env.WORKSPACE + ':/home/user/hostcwd --entrypoint=""'
                }
            }
            steps {
                sh 'buildozer --version'
                sh 'buildozer android debug'
            }
        }
    }
}